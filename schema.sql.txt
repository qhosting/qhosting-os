
-- Q-SYSTEM Database Schema
-- Project: QHOSTING.NET Titan Management

-- Roles Definition
CREATE TYPE user_role AS ENUM ('ceo', 'admin', 'client');

-- Types for Status Management
CREATE TYPE service_status AS ENUM ('active', 'suspended', 'pending_provision');
CREATE TYPE domain_status AS ENUM ('pending_purchase', 'active', 'expired');

-- Users Table
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role user_role DEFAULT 'client',
    aurum_id VARCHAR(50) UNIQUE, -- Reference to External ERP
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Hosting Services (cPanel Accounts)
CREATE TABLE IF NOT EXISTS services (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    domain VARCHAR(255) NOT NULL,
    plan_type VARCHAR(50) NOT NULL,
    cpanel_user VARCHAR(32),
    server_ip VARCHAR(45),
    status service_status DEFAULT 'pending_provision',
    next_due_date DATE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Manual Domains Tracker
CREATE TABLE IF NOT EXISTS domains_manual (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    domain_name VARCHAR(255) UNIQUE NOT NULL,
    registrar VARCHAR(100),
    status domain_status DEFAULT 'pending_purchase',
    expiration_date DATE,
    expiry_notification_sent BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_services_user ON services(user_id);
CREATE INDEX idx_domains_user ON domains_manual(user_id);
