
version: '3.8'

services:
  backend:
    build: .
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://qadmin:qpass@db:5432/qsystem
      - REDIS_URL=redis://cache:6379
      # --- SYNC WITH SERVER.TS ---
      - WHM_API_TOKEN=${WHM_API_TOKEN}
      - TITAN_HOST=${TITAN_HOST}
      - AURUM_SHARED_SECRET=${AURUM_SHARED_SECRET}
      # ---------------------------
      - WAHA_URL=http://waha:3000
      - N8N_URL=http://n8n:5678
      - NODE_ENV=production
    depends_on:
      - db
      - cache
      - waha
      - n8n

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=qadmin
      - POSTGRES_PASSWORD=qpass
      - POSTGRES_DB=qsystem
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./schema.sql:/docker-entrypoint-initdb.d/schema.sql

  cache:
    image: redis:7-alpine
    command: redis-server --appendonly yes

  # Titan Nexus: Workflow Automation
  n8n:
    image: docker.n8n.io/n8nio/n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=n8n
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:5678/
    volumes:
      - n8n_data:/home/node/.n8n

  # Titan Nexus: WhatsApp HTTP API (WAHA)
  waha:
    image: devlikeapro/waha
    restart: on-failure
    environment:
      - WHATSAPP_DEFAULT_ENGINE=WEBJS
      - WHATSAPP_RESTART_ON_FAIL=True
      - WHATSAPP_AUTOCLOSE_SESSION=False
    ports:
      - "3001:3000"
    volumes:
      - waha_data:/app/.waha

volumes:
  postgres_data:
  n8n_data:
  waha_data:
